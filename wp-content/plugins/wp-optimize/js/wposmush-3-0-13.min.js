function wpo_parse_json(s){try{var e=JSON.parse(s);return e}catch(o){console.log("WPO: Exception when trying to parse JSON (1) - will attempt to fix/re-parse"),console.log(s)}var i=s.indexOf("{"),a=s.lastIndexOf("}");if(i>-1&&a>-1){var n=s.slice(i,a+1);try{var t=JSON.parse(n);return console.log("WPO: JSON re-parse successful"),t}catch(o){console.log("WPO: Exception when trying to parse JSON (2) - will attempt to fix/re-parse based upon bracket counting");for(var m=i,_=0,r="",u=!1;(_>0||m==i)&&m<=a;){var c=s.charAt(m);u||"{"!=c?u||"}"!=c?'"'==c&&"\\"!=r&&(u=!u):_--:_++,r=c,m++}console.log("Started at cursor="+i+", ended at cursor="+m+" with result following:"),console.log(s.substring(i,m));try{var t=JSON.parse(s.substring(i,m));return console.log("WPO: JSON re-parse successful"),t}catch(o){throw o}}}throw"WPO: could not parse the JSON"}jQuery(document).ready(function(s){WP_Optimize_Smush=WP_Optimize_Smush()});var WP_Optimize_Smush=function(){function s(){var s=0==x('input[type="checkbox"]:checked',O).length;N.prop("disabled",s),W.prop("disabled",s)}function e(e){var e="undefined"==typeof e||e,o={use_cache:e};console.log("Loading information about uncompressed images."),I.html("..."),U.hide(),g(!0),y("get_ui_update",o,function(e){console.log("Information about uncompressed images loaded."),v(e,_),d(),g(!1),s()})}function o(){x("#wpo_smush_images_grid input:checked").each(function(){image={attachment_id:x(this).val(),blog_id:x(this).data("blog")},L.push(image)}),data={optimization_id:"smush",selected_images:L,smush_options:{compression_server:x("input[name='compression_server']:checked").val(),image_quality:x("#image_quality").val(),lossy_compression:x("#smush-lossy-compression").is(":checked"),back_up_original:x("#smush-backup-original").is(":checked"),preserve_exif:x("#smush-preserve-exif").is(":checked")}},r(),y("process_bulk_smush",data)}function a(){if(x("#wp-optimize-wrap").length){x("#wpo_smush_images_save_options_spinner").show().delay(3e3).fadeOut(),x("#enable_custom_compression").is(":checked")?(image_quality=x("#custom_compression_slider").val(),lossy_compression=image_quality<100):(image_quality=x("#enable_lossy_compression").is(":checked")?90:100,lossy_compression=image_quality<100);var s={compression_server:x("input[name='compression_server']:checked").val(),image_quality:image_quality,lossy_compression:lossy_compression,back_up_original:x("#smush-backup-original").is(":checked"),back_up_delete_after:x("#smush-backup-delete").is(":checked"),back_up_delete_after_days:x("#smush-backup-delete-days").val(),preserve_exif:x("#smush-preserve-exif").is(":checked"),autosmush:x("#smush-automatically").is(":checked"),show_smush_metabox:x("#smush-show-metabox").is(":checked")};y("update_smush_options",s,function(s){x("#wpo_smush_images_save_options_spinner").hide(),s.hasOwnProperty("saved")&&s.saved?(x("#wpo_smush_images_save_options_done").show().delay(3e3).fadeOut(),P.hide()):(x("#wpo_smush_images_save_options_fail").show().delay(3e3).fadeOut(),P.show())})}}function n(){Q=!0,E++,seconds=E%60+""<10?"0"+E%60:E%60,minutes=parseInt(E/60)+""<10?"0"+parseInt(E/60):parseInt(E/60),x("#smush_stats_timer").text(minutes+":"+seconds),t(E)}function t(s){0==s%3&&m(),0==s%60&&y("process_pending_images",{},function(s){v(s,u)})}function m(s){data={update_ui:!0,use_cache:!1},y("get_ui_update",data,function(s){v(s,u)})}function _(s){if(O.html(""),s&&s.hasOwnProperty("unsmushed_images")){s.unsmushed_images,s.pending_tasks;0==s.unsmushed_images.length&&0==s.pending_tasks&&O.text(wposmush.all_images_compressed).wrapInner("<div class='wpo-fieldgroup'> </div>"),0!=s.pending_tasks&&U.show().find(".red").text(s.pending);var e="post.php?post=",o="&action=edit";for(blog_id in s.unsmushed_images)for(i in s.unsmushed_images[blog_id])s.unsmushed_images[blog_id].hasOwnProperty(i)&&(image=s.unsmushed_images[blog_id][i],p(image,blog_id,s.admin_urls[blog_id]+e+image.id+o))}}function r(){Q||(k(x("#wpo_smush_images_information_container")),service=x('.compression_server input[type="radio"]:checked + label small').text(),x("#wpo_smush_images_information_server").html(service),x("#smush_stats_pending_images").html("..."),x("#smush_stats_completed_images").html("..."),x("#smush_stats_bytes_saved").html("..."),x("#smush_stats_percent_saved").html("..."),x("#smush_stats_timer").html("..."),D=window.setInterval(n,1e3),g(!0))}function u(s){x("#smush_stats_pending_images").html(s.pending_tasks),x("#smush_stats_completed_images").html(s.completed_task_count),x("#smush_stats_bytes_saved").html(s.bytes_saved),x("#smush_stats_percent_saved").html(s.percent_saved),1==s.smush_complete&&setTimeout(c,1500)}function c(){data={update_ui:!0,use_cache:!1,image_list:L},y("get_ui_update",data,function(s){summary=s.session_stats,0!=s.completed_task_count&&(summary+="<hr>"+s.summary),l(summary)})}function l(s){R||(x("#summary-message").html(s),h(),k(x("#smush-complete-summary")),R=!0)}function h(){E=0,Q=!1,R=!1,L=[],window.clearInterval(D),g(!1)}function p(s,e,o){var i=["wpo_smush_",e,"_",s.id].join("");image_html='<div class="wpo_smush_image" data-filesize="'+s.filesize+'">',image_html+='<a class="button" href="'+o+'" target="_blank"> '+wposmush.view_image+" </a>",image_html+='<input id="'+i+'" type="checkbox" data-blog="'+e+'" class="wpo_smush_image__input" value="'+s.id+'">',image_html+='<label for="'+i+'"></a>',image_html+='<div class="thumbnail">',image_html+='<img class="lazyload" src="'+s.thumb_url+'">',image_html+="</div></label></div>",O.append(image_html)}function d(){features=wposmush.features,service=x("input[name^='compression_server']:checked").val();for(feature in features[service])x("."+feature).prop("disabled",!features[service][feature]);x(".wpo_smush_image").each(function(){x(this).data("filesize")>wposmush.features[service].max_filesize?x(this).hide():x(this).show()})}function g(s){x.each([N,S,j,P,q,z,W],function(e,o){o.prop("disabled",s)}),s?(x("#wpo_smush_images_refresh").hide(),x(".wpo_smush_images_loader").show()):(x("#wpo_smush_images_refresh").show(),x(".wpo_smush_images_loader").hide())}function f(s,e){0!=s.length&&(data={selected_image:s,smush_options:e},k(wposmush.compress_single_image_dialog),y("compress_single_image",data,function(s){v(s,b)}))}function w(s){0!=s.length&&(k(wposmush.please_wait,x.unblockUI),data={selected_image:s},y("restore_single_image",data,function(s){v(s,b)}))}function b(s){if(s.hasOwnProperty("success")&&s.success)if(x("#smush-information").text(s.summary),k(x("#smush-information-modal"),x.unblockUI),x(".toggle-smush-advanced.wpo_smush_single_image").removeClass("opened"),"compress"==s.operation)x(".wpo_smush_single_image").hide(),x(".wpo_restore_single_image").show(),x("#smush_info").text(s.summary),x(".wpo_smush_mark_single_image").hide(),s.restore_possible?x(".restore_possible").show():x(".restore_possible").hide();else{x(".wpo_smush_single_image").show(),x(".wpo_restore_single_image").hide();x("#smush_info").closest("#smush-metabox-inside-wrapper");x(".wpo_smush_mark_single_image").show()}else x("#smush-information").text(s.error_message),k(x("#smush-information-modal"),x.unblockUI)}function k(s,e){x.blockUI({message:s,onOverlayClick:e,baseZ:160001,css:{width:"400px",padding:"20px",cursor:"pointer"}})}function v(s,e){s&&s.hasOwnProperty("status")&&s.status?e&&e(s):(alert(wposmush.error_unexpected_response),console.log(s))}function y(s,e,o,i){i="undefined"==typeof i||i,e=x.isEmptyObject(e)?{use_cache:!1}:e;var a={action:"updraft_smush_ajax",subaction:s,nonce:wposmush.smush_ajax_nonce,data:e},n={type:"POST",url:ajaxurl,data:a,success:function(s){if(i){try{var e=wpo_parse_json(s)}catch(a){console.log("smush_manager_send_command JSON parse error"),console.log(a),console.log(s),alert(wposmush.error_unexpected_response)}"undefined"!=typeof o&&o(e)}else"undefined"!=typeof o&&o(s)},error:function(s,e,i){console.log("smush_manager_send_command AJAX parse error: "+e+" ("+i+")"),"undefined"!=typeof o?o(s):(console.log(s),alert(wposmush.error_unexpected_response))},dataType:"text"};x.ajax(n)}var x=jQuery,O=(x("#wp-optimize-images-nav-tab-smush"),x("#wpo_smush_images_grid")),I=x("#smush_info_images"),U=x("#wpo_smush_images_pending_tasks_container"),z=x("#wpo_smush_images_pending_tasks_button"),P=x(".wpo-fieldgroup #wpo_smush_images_save_options_button"),q=x("#wpo_smush_images_refresh"),S=x("#wpo_smush_images_select_all"),j=x("#wpo_smush_images_select_none"),J=x("#wpo_smush_clear_stats_btn"),N=x("#wpo_smush_images_btn"),W=x("#wpo_smush_mark_as_compressed"),C=(x(".wpo_smush_single_image .button"),x(".wpo_restore_single_image .button"),x(".wpo_smush_get_logs")),T=x("#wpo_smush_delete_backup_btn"),A=x(".compression_server"),E=0,Q=!1,D=0,L=[],R=!1;x("#wp-optimize-nav-tab-wrapper__wpo_images .nav-tab").on("click",function(){x(this).is("#wp-optimize-nav-tab-wpo_images-smush")&&e()}),x("#wp-optimize-wrap").on("page-change",function(s,o){"wpo_images"==o.page&&x("#wp-optimize-nav-tab-wrapper__wpo_images .nav-tab-active").is("#wp-optimize-nav-tab-wpo_images-smush")&&e()}),x("#smush-metabox").length>0&&d(),O.on("change",'input[type="checkbox"]',function(){s()}),s(),A.on("change",function(s){d(),a()}),N.off().on("click",function(){return 0==x('#wpo_smush_images_grid input[type="checkbox"]:checked').length?(x("#smush-information-modal #smush-information").text(wposmush.please_select_images),void k(x("#smush-information-modal"),x.unblockUI)):(x("#smush-information-modal #smush-information").text(wposmush.server_check),k(x("#smush-information-modal")),data={server:x("input[name='compression_server']:checked").val()},void y("check_server_status",data,function(s){s.online?o():(s.error?(error_message=s.error+"<br>"+wposmush.server_error,x("#smush-information-modal #smush-information").html(error_message)):x("#smush-information-modal #smush-information").text(wposmush.server_error),k(x("#smush-information-modal"),x.unblockUI))}))}),W.off().on("click",function(){if(0==x('#wpo_smush_images_grid input[type="checkbox"]:checked').length)return x("#smush-information-modal #smush-information").text(wposmush.please_select_compressed_images),void k(x("#smush-information-modal"),x.unblockUI);var s,o=[];x("#wpo_smush_images_grid input:checked").each(function(){s={attachment_id:x(this).val(),blog_id:x(this).data("blog")},o.push(s)}),k(wposmush.please_updating_images_info),y("mark_as_compressed",{selected_images:o},function(s){x("#smush-information-modal #smush-information").text(s.summary),k(x("#smush-information-modal"),x.unblockUI),e()})}),q.off().on("click",function(){e()}),S.off().on("click",function(){x('#wpo_smush_images_grid input[type="checkbox"]').prop("checked",!0),s()}),j.off().on("click",function(){x('#wpo_smush_images_grid input[type="checkbox"]').prop("checked",!1),s()}),C.off().on("click",function(){x("#log-panel").text("Please wait, fetching logs."),y("get_smush_logs",{},function(s){x.blockUI({message:x("#smush-log-modal"),onOverlayClick:x.unblockUI(),css:{width:"80%",height:"80%",top:"15%",left:"15%"}}),x("#log-panel").html("<pre>"+s+"</pre>"),download_link=ajaxurl+"?action=updraft_smush_ajax&subaction=get_smush_logs&nonce="+wposmush.smush_ajax_nonce,x("#smush-log-modal a").attr("href",download_link),console.log(download_link)},!1)}),T.on("click",function(){if(confirm(wposmush.delete_image_backup_confirm)){T.prop("disabled",!0);var s=x("#wpo_smush_delete_backup_spinner"),e=x("#wpo_smush_delete_backup_done");s.show(),y("clean_all_backup_images",{},function(){s.hide(),T.prop("disabled",!1),e.css("display","inline-block").delay(3e3).fadeOut()})}}),P.off().on("click",function(s){a()}),J.off().on("click",function(s){x("#wpo_smush_images_clear_stats_spinner").show().delay(3e3).fadeOut(),y("clear_smush_stats",{},function(s){x("#wpo_smush_images_clear_stats_spinner").hide(),x("#wpo_smush_images_clear_stats_done").show().delay(3e3).fadeOut()})}),z.off().on("click",function(s){x("#smush-information-modal #smush-information").text(wposmush.server_check),k(x("#smush-information-modal"),x.unblockUI),data={server:x("input[name='compression_server']:checked").val()},y("check_server_status",data,function(s){s.online?(r(),y("process_pending_images",{},function(s){v(s,u)})):(s.error?(error_message=s.error+"<br>"+wposmush.server_error,x("#smush-information-modal #smush-information").html(error_message)):x("#smush-information-modal #smush-information").text(wposmush.server_error),k(x("#smush-information-modal"),x.unblockUI))})}),x("body").on("click","#wpo_smush_images_pending_tasks_cancel_button",function(s){y("clear_pending_images",{},function(s){x.unblockUI(),s.status?(e(),h()):console.log("Cancelling pending images apparently failed.",s)})}),x("body").on("click",".wpo_smush_single_image .button",function(){image={attachment_id:x(this).data("id"),blog_id:x(this).data("blog")},x("#enable_custom_compression").is(":checked")?(image_quality=x("#custom_compression_slider").val(),lossy_compression=image_quality<100):(image_quality=x("#enable_lossy_compression").is(":checked")?90:100,lossy_compression=image_quality<100),smush_options={compression_server:x("input[name='compression_server_"+image.attachment_id+"']:checked").val(),image_quality:image_quality,lossy_compression:lossy_compression,back_up_original:x("#smush_backup_"+image.attachment_id).is(":checked"),preserve_exif:x("#smush_exif_"+image.attachment_id).is(":checked")},console.log("Compressing Image : "+image.attachment_id),data={server:x("input[name='compression_server_"+x(this).attr("id").substring(15)+"']:checked").val()},k(wposmush.server_check),y("check_server_status",data,function(s){s.online?f(image,smush_options):s.error?(error_message=s.error+"<br>"+wposmush.server_error,k(error_message,x.unblockUI)):k(wposmush.server_error,x.unblockUI)})}),x("body").on("click",".wpo_restore_single_image .button",function(){var s=x(this).attr("id");s&&(image_id=s.substring(25),console.log("Restoring Image : "+image_id),w(image_id))}),x("body").on("click",".wpo_smush_mark_single_image .button",function(){var s={attachment_id:x(this).data("id"),blog_id:x(this).data("blog")},e=x(this).closest("#smush-metabox-inside-wrapper");k(wposmush.please_updating_images_info),y("mark_as_compressed",{selected_images:[s]},function(s){x("#smush-information-modal #smush-information").text(s.summary),k(x("#smush-information-modal"),x.unblockUI),s.status&&(x(".wpo_smush_single_image",e).hide(),x(".toggle-smush-advanced",e).removeClass("opened"),x(".wpo_smush_mark_single_image",e).hide(),x(".wpo_smush_unmark_single_image",e).show(),x(".wpo_restore_single_image",e).show(),x("#smush_info",e).text(s.info))})}),x("body").on("click",".wpo_smush_unmark_single_image .button",function(){var s={attachment_id:x(this).data("id"),blog_id:x(this).data("blog")},e=x(this).closest("#smush-metabox-inside-wrapper");k(wposmush.please_updating_images_info),y("mark_as_compressed",{selected_images:[s],unmark:!0},function(s){x("#smush-information-modal #smush-information").text(s.summary),k(x("#smush-information-modal"),x.unblockUI),s.status&&(x(".wpo_smush_single_image",e).show(),x(".wpo_smush_mark_single_image",e).show(),x(".wpo_smush_unmark_single_image",e).hide(),x(".wpo_restore_single_image",e).hide(),x("#smush_info",e).text(""))})}),x("body").on("click","#smush-log-modal .close, #smush-information-modal .information-modal-close",function(){x.unblockUI()}),x("body").on("click",".wpo_smush_stats_cta_btn, .wpo_smush_get_logs, #smush-complete-summary .close",function(){x.unblockUI(),e(),setTimeout(h,500)}),x("body").on("click",".toggle-smush-advanced",function(s){s.preventDefault(),x(this).toggleClass("opened")}),x(".wpo-fieldgroup .autosmush input, .wpo-fieldgroup .compression_level, .wpo-fieldgroup .image_options, #smush-show-metabox").on("change",function(s){a()}),x("body").on("change",".smush-options.compression_level",function(){x("#enable_custom_compression").is(":checked")?x(".smush-options.custom_compression").show():x(".smush-options.custom_compression").hide()}),x("body").on("change",'.smush-advanced input[type="radio"]',function(){d()})};